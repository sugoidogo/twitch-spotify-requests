<style>
    iframe {
        width: 100%;
        height: 100%;
    }
    body {
        overflow:hidden;
    }
</style>
<script type="module">
    window.onerror=function(event, source, line, column, error){
        let message='<h1>'+event+'<br><br>'+source+':'+line+':'+column+'</h1><br>'
        if('stack' in error){
            message+=error.stack.replaceAll('at ','<br>at ')+'<br><br>'
        }
        for(const key of Object.getOwnPropertyNames(error)){
            message+=key+': '+error[key]+'<br><br>'
        }
        document.body.innerHTML=message
    }

    window.onbeforeunload=function(){
        setRewardPaused()
    }

    const twitch_client_id = 'fzm8wzgt2qf608y4trmp7r19ytbfkc'
    const twitch_client_secret = 'e036ddpijlwc9a1nzoekqc383vgakh'
    const spotify_client_id = '61529d38670a4288beee6136eb9a4e58'
    const params = new URLSearchParams(location.search)
    const initial_twitch_token = JSON.parse(params.get('twitchToken'))
    const initial_spotify_token = JSON.parse(params.get('spotifyToken'))

    import { RefreshingAuthProvider, exchangeCode } from 'https://cdn.jsdelivr.net/npm/@twurple/auth/+esm'
    const authProvider = new RefreshingAuthProvider({
        clientId: twitch_client_id,
        clientSecret: twitch_client_secret
    })

    import { ApiClient } from 'https://cdn.jsdelivr.net/npm/@twurple/api/+esm'
    const twitch = new ApiClient({ authProvider: authProvider })
    window.twitch=twitch

    import localforage from 'https://cdn.jsdelivr.net/npm/localforage/+esm'
    const storage = localforage.createInstance({ name: location.pathname })

    authProvider.onRefresh((user_id, token) => {
        token.user_id = user_id
        twitchToken = token
        storage.setItem('twitchToken', twitchToken)
    })

    let twitchToken = (await storage.getItem('twitchToken')) || initial_twitch_token
    console.debug(twitchToken)
    await authProvider.addUser(twitchToken.user_id, twitchToken, ['chat'])

    import WebStorage from 'https://ts.sugoidogo.com/storage.mjs'
    const webStorage=new WebStorage(authProvider,twitchToken.user_id)

    const setLocal=localStorage.setItem
    localStorage.setItem=function(key,value){
        setLocal(key,value)
        if(key==='spotify-sdk:AuthorizationCodeWithPKCEStrategy:token'){
            webStorage.setItem('spotifyToken',value)
        }
    }

    import { SpotifyApi } from 'https://cdn.jsdelivr.net/npm/@spotify/web-api-ts-sdk/+esm'
    let spotifyToken = await webStorage.getItem('spotifyToken').then(response=>response.json())
    console.debug(spotifyToken)
    const spotify = SpotifyApi.withAccessToken(spotify_client_id, spotifyToken)
    window.spotify = spotify
    window.SpotifyApi = SpotifyApi

    const reward = (await twitch.channelPoints.getCustomRewards(twitchToken.user_id, true))[0]

    import { EventSubWsListener } from 'https://cdn.jsdelivr.net/npm/@twurple/eventsub-ws/+esm';
    const eventListener = new EventSubWsListener({ apiClient: twitch })
    eventListener.onChannelRedemptionAddForReward(twitchToken.user_id, reward.id, async function onRedemption(event) {
        const results = await spotify.search(event.input, ['track'], undefined, 1)
        const track = results.tracks.items[0]
        console.debug(track)
        try{
            await spotify.player.addItemToPlaybackQueue(track.uri)
        }catch(e){
            console.error(e)
            twitch.channelPoints.updateRedemptionStatusByIds(twitchToken.user_id,reward.id,event.id,"CANCELED")
        }
    })
    
    eventListener.start()

    function setRewardPaused(isPaused=true){
        twitch.channelPoints.updateCustomReward(twitchToken.user_id,reward.id,{
                isPaused:isPaused
            })
    }

    /**
    if(params.get('webPlayback')){
        console.debug('loading web player')
        window.onSpotifyWebPlaybackSDKReady = () => {
            const player = new Spotify.Player({
                name: 'SugoiSpotifyRequests',
                getOAuthToken: cb => { cb(spotify.authenticationStrategy.accessToken.access_token); },
                volume: 1
            });
            player.addListener('ready',({device_id})=>{
                spotify.player.transferPlayback([device_id],false)
            })
            player.connect()
        }
        await import('https://sdk.scdn.co/spotify-player.js')
        setRewardPaused(false)
    }else{
        if(!await spotify.player.getPlaybackState()){
            setRewardPaused()
        }else{
            setRewardPaused(false)
        }
    }
    */

    if(!await spotify.player.getPlaybackState()){
        const devices=(await spotify.player.getAvailableDevices()).devices
        if(devices.length===0){
            setRewardPaused()
            window.alert('Spotify Song Requests: No Available Devices!')
            const intervalID=setInterval(async function(){
                const devices=(await spotify.player.getAvailableDevices()).devices
                if(devices.length>0){
                    spotify.player.transferPlayback([devices[0].id],false)
                    setRewardPaused(false)
                    clearInterval(intervalID)
                }
            },1000)
        }else{
            spotify.player.transferPlayback([devices[0].id],false)
            setRewardPaused(false)
        }
    }
</script>